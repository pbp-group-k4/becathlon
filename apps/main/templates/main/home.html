<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Becathlon â€” Performance Elevated</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    {% load static %}
    <link rel="stylesheet" href="{% static 'main/css/home.css' %}?v=1">
    <link rel="stylesheet" href="{% static 'main/css/hero.css' %}?v=2">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <header class="header">
        <nav class="nav">
            <a href="/" class="logo" style="text-decoration: none; cursor: pointer;">BECATHLON</a>
            <div class="nav-links">
                {% if request.resolver_match.app_name != 'catalog' %}
                    <a href="{% url 'catalog:home' %}">Catalog</a>
                {% endif %}
                {% if request.resolver_match.app_name != 'stores' %}
                    <a href="{% url 'stores:locator' %}">Stores</a>
                {% endif %}
                {% if request.resolver_match.url_name != 'cart_view' %}
                    <a href="{% url 'cart:cart_view' %}" style="position: relative;">
                        Cart
                        <span class="cart-badge" style="display: none;">0</span>
                    </a>
                {% endif %}
                {% if user.is_authenticated %}
                    {% if request.resolver_match.app_name != 'order' %}
                        <a href="{% url 'order:order_list' %}">Orders</a>
                    {% endif %}
                    <a href="{% url 'profiles:detail' %}" class="user-info">{{ user.username }}</a>
                    <form method="post" action="{% url 'auth:logout' %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit">Sign Out</button>
                    </form>
                {% else %}
                    <a href="{% url 'auth:login' %}">Sign In</a>
                    <a href="{% url 'auth:signup' %}">Sign Up</a>
                {% endif %}
            </div>
        </nav>
    </header>

    <div class="messages" id="messagesContainer">
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    </div>

    {% block content %}
    <!-- Dynamic Hero Section -->
    <section class="hero">
        <!-- Animated Background Elements -->
        <div class="hero-canvas-container">
            <canvas id="heroCanvas"></canvas>
        </div>
        
        <!-- Floating Gradient Orbs -->
        <div class="hero-orb hero-orb-1"></div>
        <div class="hero-orb hero-orb-2"></div>
        
        <!-- Geometric Grid -->
        <div class="hero-grid"></div>
        
        <!-- Orb Masking Layer (improves text readability) -->
        <div class="hero-orb-mask"></div>
        
        <!-- Hero Content -->
        <div class="hero-content">
            <h1 class="hero-title">
                <span class="hero-title-line">Where Tech Meets</span>
                <span class="hero-title-line"><span class="hero-title-highlight">Performance</span></span>
            </h1>
            
            <p class="hero-subtitle">
                Experience the future of athletic excellence. Premium equipment engineered for champions, designed for those who push boundaries.
            </p>
            
            <div class="hero-cta">
                {% if user.is_authenticated %}
                    <a href="{% url 'catalog:home' %}" class="hero-btn hero-btn-primary">
                        <span>Explore Catalog</span>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </a>
                    <a href="{% url 'cart:cart_view' %}" class="hero-btn hero-btn-secondary">
                        <span>View Cart ({{ cart_item_count }})</span>
                    </a>
                {% else %}
                    <a href="{% url 'auth:signup' %}" class="hero-btn hero-btn-primary">
                        <span>Get Started</span>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </a>
                    <a href="{% url 'auth:login' %}" class="hero-btn hero-btn-secondary">
                        <span>Sign In</span>
                    </a>
                {% endif %}
            </div>
        </div>
        
        <!-- Stats Section -->
        <div class="hero-stats">
            <div class="hero-stat">
                <div class="hero-stat-value" data-target="12">0</div>
                <div class="hero-stat-label">Sport Categories</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value" data-target="500">0</div>
                <div class="hero-stat-label">Premium Products</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value" data-target="10000">0</div>
                <div class="hero-stat-label">Athletes Worldwide</div>
            </div>
        </div>
        
        <!-- Scroll Indicator -->
        <div class="hero-scroll-indicator">
            <div class="scroll-arrow"></div>
        </div>
    </section>

    <div class="container">
        {% if not user.is_authenticated %}
        <section class="auth-prompt">
            <h3>Access Exclusive Gear</h3>
            <p>Join an elite community of athletes and innovators. Unlock your potential with premium equipment designed for peak performance.</p>
            <div class="btn-group">
                <a href="{% url 'auth:signup' %}" class="btn btn-primary">Request Access</a>
                <a href="{% url 'auth:login' %}" class="btn btn-secondary">Member Login</a>
            </div>
        </section>
        {% endif %}

        {% if user.is_authenticated and user.profile.account_type == 'SELLER' %}
        <section class="section">
            <h2>List Equipment</h2>
            <form id="addProductForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="productName">Equipment Name</label>
                        <input type="text" id="productName" placeholder="Enter product name" required>
                    </div>

                    <div class="form-group">
                        <label for="productType">Category</label>
                        <select id="productType" required>
                            <option value="">Select Category</option>
                            {% for type in product_types %}
                            <option value="{{ type.id }}">{{ type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="productPrice">Price (USD)</label>
                        <input type="number" id="productPrice" step="0.01" min="0" placeholder="0.00" required>
                    </div>

                    <div class="form-group">
                        <label for="productStock">Quantity</label>
                        <input type="number" id="productStock" min="0" value="0" placeholder="0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="productDescription">Specifications</label>
                    <textarea id="productDescription" placeholder="Describe the equipment features and specifications" required></textarea>
                </div>

                <div class="form-group">
                    <label for="productImage">Image URL</label>
                    <input type="url" id="productImage" placeholder="https://example.com/image.jpg">
                </div>

                <button type="submit" class="btn btn-primary">Submit Listing</button>
            </form>
        </section>
        {% endif %}

        {% if user.is_authenticated %}
        <section class="section" id="recommendations-section">
            <h2 class="section-title">Recommended for You</h2>

            <div class="recommendations-wrapper">
                {% include "recommendation/product_recommendations.html" with recommendations=recommendations %}
            </div>
        </section>
        {% endif %}

        <section class="section">
            <h2>Equipment Catalog</h2>
            <form id="filterForm" style="margin-bottom:2rem;display:flex;gap:1rem;flex-wrap:wrap;">
                <input type="text" id="searchQuery" placeholder="Search keyword..." style="padding:0.5rem;">
                <select id="filterType" style="padding:0.5rem;">
                    <option value="">All Categories</option>
                    {% for type in product_types %}
                    <option value="{{ type.id }}">{{ type.name }}</option>
                    {% endfor %}
                </select>
                <input type="number" id="minPrice" placeholder="Min price" step="0.01" style="padding:0.5rem;width:120px;">
                <input type="number" id="maxPrice" placeholder="Max price" step="0.01" style="padding:0.5rem;width:120px;">
                <button type="button" id="applyFilters" class="btn btn-secondary">Filter</button>
            </form>
            <div id="productsGrid" class="products-grid">
                <!-- Products will be loaded via AJAX -->
            </div>
        </section>
        {% endblock %}
    </div>
    <div id="user-data" data-authenticated="{{ user.is_authenticated|yesno:'true,false' }}" data-username="{{ user.username }}"></div>

    <script>
        const userData = document.getElementById('user-data');
        const isAuthenticated = userData.dataset.authenticated === 'true';
        const currentUsername = userData.dataset.username;        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Show message
        function showMessage(message, type) {
            // Hide error messages - just log to console
            if (type === 'error') {
                console.log(`[ERROR]: ${message}`);
                return;
            }
            
            const messagesContainer = document.getElementById('messagesContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            messagesContainer.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Load products with pagination
        let currentPage = 1;
        let isLoadingMore = false;
        
        async function loadProducts(resetPage = true) {
            try {
                if (resetPage) {
                    currentPage = 1;
                }
                
                const queryParams = new URLSearchParams({
                    q: document.getElementById('searchQuery')?.value || '',
                    type: document.getElementById('filterType')?.value || '',
                    min_price: document.getElementById('minPrice')?.value || '',
                    max_price: document.getElementById('maxPrice')?.value || '',
                    page: currentPage,
                    per_page: 20  // Initial load: 20 items
                }).toString();

                const response = await fetch(`/api/products/?${queryParams}`);
                const data = await response.json();
                const productsGrid = document.getElementById('productsGrid');

                if (data.products.length === 0 && currentPage === 1) {
                    productsGrid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">â”€</div>
                            <h3>Catalog Initialization</h3>
                            <p>No equipment currently listed. Be among the first to contribute to our premium collection.</p>
                        </div>
                    `;
                    return;
                }

                const productsHTML = data.products.map(product => `
                <div class="product-card">
                    <a href="/product/${product.id}/" style="text-decoration:none;color:inherit;">
                    <div class="product-image">
                        ${product.image_url
                        ? `<img src="${product.image_url}" alt="${product.name}" style="width:100%;height:100%;object-fit:cover;">`
                        : '<div style="font-size: 3rem; opacity: 0.3;">â”€</div>'}
                    </div>
                    </a>

                    <div class="product-content">
                    <span class="product-category">${product.product_type}</span>
                    <a href="/product/${product.id}/" style="text-decoration:none;color:inherit;">
                        <div class="product-name">${product.name}</div>
                    </a>
                    <div class="product-description">${product.description}</div>
                    <div class="product-price">$${parseFloat(product.price).toFixed(2)}</div>
                    <div class="product-stock">Quantity: ${product.stock} Available</div>
                    <div class="product-meta">${product.created_by} â€¢ ${product.created_at}</div>
                    ${product.can_delete ? `<button class="btn-danger" onclick="deleteProduct(${product.id})">Remove Listing</button>` : ''}
                    </div>
                </div>
                `).join('');
                
                if (resetPage || currentPage === 1) {
                    productsGrid.innerHTML = productsHTML;
                } else {
                    // Append to existing products
                    productsGrid.innerHTML += productsHTML;
                }
                
                // Handle Load More button
                updateLoadMoreButton(data.pagination);
                isLoadingMore = false;
                
            } catch (error) {
                console.error('Error loading products:', error);
                showMessage('Error loading products', 'error');
                isLoadingMore = false;
            }
        }
        
        // Update or create "Load More" button
        function updateLoadMoreButton(pagination) {
            let loadMoreContainer = document.getElementById('load-more-container');
            
            if (!loadMoreContainer) {
                loadMoreContainer = document.createElement('div');
                loadMoreContainer.id = 'load-more-container';
                loadMoreContainer.style.cssText = 'text-align:center;margin:3rem 0;';
                document.getElementById('productsGrid').parentElement.appendChild(loadMoreContainer);
            }
            
            if (pagination.has_next) {
                const showing = currentPage * pagination.per_page;
                const remaining = pagination.total_count - showing;
                
                loadMoreContainer.innerHTML = `
                    <p style="color:var(--light-gray);margin-bottom:1rem;">
                        Showing ${Math.min(showing, pagination.total_count)} of ${pagination.total_count} products
                    </p>
                    <button id="load-more-btn" class="btn btn-secondary" style="min-width:200px;">
                        Load More (${Math.min(remaining, pagination.per_page)} more)
                    </button>
                `;
                
                document.getElementById('load-more-btn').addEventListener('click', function() {
                    if (!isLoadingMore) {
                        isLoadingMore = true;
                        this.textContent = 'Loading...';
                        this.disabled = true;
                        currentPage++;
                        loadProducts(false);
                    }
                });
            } else {
                loadMoreContainer.innerHTML = `
                    <p style="color:var(--light-gray);">
                        Showing all ${pagination.total_count} products
                    </p>
                `;
            }
        }

        // Add product
        if (isAuthenticated) {
            const addProductForm = document.getElementById('addProductForm');
            if (addProductForm) {
                addProductForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const formData = {
                        name: document.getElementById('productName').value,
                        description: document.getElementById('productDescription').value,
                        price: parseFloat(document.getElementById('productPrice').value),
                        product_type: document.getElementById('productType').value,
                        stock: parseInt(document.getElementById('productStock').value),
                        image_url: document.getElementById('productImage').value || ''
                    };

                    try {
                        const response = await fetch('/api/products/add/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrftoken
                            },
                            body: JSON.stringify(formData)
                        });

                        const data = await response.json();

                        if (data.success) {
                            showMessage('Equipment listing submitted successfully', 'success');
                            document.getElementById('addProductForm').reset();
                            loadProducts();
                        } else {
                            showMessage(data.error || 'Unable to submit listing', 'error');
                        }
                    } catch (error) {
                        console.error('Error adding product:', error);
                        showMessage('Submission failed. Please try again', 'error');
                    }
                });
            }
        }

        // Delete product
        async function deleteProduct(productId) {
            if (!confirm('Confirm removal of this equipment listing?')) {
                return;
            }

            try {
                const response = await fetch(`/api/products/${productId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('Listing removed from catalog', 'success');
                    loadProducts();
                } else {
                    showMessage(data.error || 'Unable to remove listing', 'error');
                }
            } catch (error) {
                console.error('Error removing product:', error);
                showMessage('Removal failed. Please try again', 'error');
            }
        }

        // Load products on page load
        loadProducts();
        const applyFiltersBtn = document.getElementById('applyFilters');
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', loadProducts);
        }
    </script>
    <script>
        window.becathlon = window.becathlon || {};
        window.becathlon.isAuthenticated = '{{ user.is_authenticated|yesno:"true,false" }}' === 'true';
        window.becathlon.loginUrl = "{% url 'auth:login' %}?next={{ request.get_full_path|urlencode }}";
    </script>
    {% load static %}
    <script src="{% static 'main/js/hero.js' %}"></script>
    <script src="{% static 'cart/js/cart.js' %}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
